"use strict";Object.defineProperty(exports, "__esModule", { value: true });var _exportNames = { logger: true, isDate: true, shouldMock: true, getHeader: true, toTitleCase: true, wrapAsync: true, methodToAction: true, toSnakeCase: true };exports.getHeader = getHeader;exports.toTitleCase = toTitleCase;exports.wrapAsync = wrapAsync;exports.toSnakeCase = toSnakeCase;exports.methodToAction = exports.shouldMock = exports.isDate = exports.logger = void 0;require("source-map-support/register");var _logger = _interopRequireDefault(require("../logger"));
var _lodash = require("lodash");
































































































































































var _auth = require("./auth");Object.keys(_auth).forEach(function (key) {if (key === "default" || key === "__esModule") return;if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;if (key in exports && exports[key] === _auth[key]) return;Object.defineProperty(exports, key, { enumerable: true, get: function () {return _auth[key];} });});
var _env = require("./env");Object.keys(_env).forEach(function (key) {if (key === "default" || key === "__esModule") return;if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;if (key in exports && exports[key] === _env[key]) return;Object.defineProperty(exports, key, { enumerable: true, get: function () {return _env[key];} });});
var _errors = require("./errors");Object.keys(_errors).forEach(function (key) {if (key === "default" || key === "__esModule") return;if (Object.prototype.hasOwnProperty.call(_exportNames, key)) return;if (key in exports && exports[key] === _errors[key]) return;Object.defineProperty(exports, key, { enumerable: true, get: function () {return _errors[key];} });});function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}const logger = _logger.default.logger;exports.logger = logger;const isDate = (obj) => Object.prototype.toString.call(obj) === '[object Date]';exports.isDate = isDate;const shouldMock = (api) => {const MOCK = process.env.MOCK || '';return MOCK.indexOf(api) !== -1 || MOCK.indexOf('*') !== -1;};exports.shouldMock = shouldMock;function getHeader(request, name) {return request.headers[toTitleCase(name)] || request.headers[name.toLowerCase()] || request.headers[name.toUpperCase()];}function toTitleCase(str) {const smallWords = /^(a|an|and|as|at|but|by|en|for|if|in|nor|of|on|or|per|the|to|v.?|vs.?|via)$/i;const alphanumericPattern = /([A-Za-z0-9\u00C0-\u00FF])/;const wordSeparators = /([ :–—-])/;return str.split(wordSeparators).map((current, index, array) => {if (current.search(smallWords) > -1 && index !== 0 && index !== array.length - 1 && array[index - 3] !== ':' && array[index + 1] !== ':' && (array[index + 1] !== '-' || array[index - 1] === '-' && array[index + 1] === '-')) {return current.toLowerCase();}if (current.substr(1).search(/[A-Z]|\../) > -1) {return current;}if (array[index + 1] === ':' && array[index + 2] !== '') {return current;}return current.replace(alphanumericPattern, function m(match) {return match.toUpperCase();});}).join('');}function wrapAsync(fn) {return (req, res, next) => {fn(req, res, next).catch(next);};}const methodToAction = (req) => {const map = { DELETE: 'delete', PATCH: 'patch', POST: 'create', PUT: 'update' };return map[req.method];};exports.methodToAction = methodToAction;function toSnakeCase(obj, options = { ignoreTransformByKey: [], ignoreSnakeKey: [] }, pathNest = [], path = []) {if (typeof obj !== 'object') {return obj;} else if (obj === null) {return null;} else if (obj.hasOwnProperty('ID')) {delete obj.ID;}return (0, _lodash.chain)(obj).mapKeys((value, key) => {const shouldIgnore = (options.ignoreSnakeKey || []).findIndex((i) => i === key) !== -1;if (shouldIgnore) {return key;}return (0, _lodash.snakeCase)(key);}).mapValues((value, key) => {const parsedPath = [...path, key].join('.');const pathHandler = pathNest.find((p) => p[parsedPath]);if (value && typeof value === 'object' && !Array.isArray(value) && value.hasOwnProperty('ID')) {delete value.ID;}if (pathHandler) {const defaultValue = pathHandler[parsedPath];if (value === null) {return defaultValue;}return (0, _lodash.transform)(value, function transformFunction(current, v, k) {let val;if (Array.isArray(v) && v.length) {val = v[0];} else {val = v;}const [name, ...subValue] = (0, _lodash.snakeCase)(k).split('_');if (name === 'id') {return current;}let prop;if (!(current !== null && current !== void 0 && current.hasOwnProperty(name))) {prop = {};} else {prop = current[name];}if (subValue.length) {prop[subValue.join('_')] = val || null;}current[name] = prop;return current;}, {});}if (!(0, _lodash.isObject)(value) && !Array.isArray(value) || isDate(value) || (options.ignoreTransformByKey || []).includes(key)) {return value;}if (!Array.isArray(value)) {return toSnakeCase(value, options, pathNest, [...path, key]);}return value.map((v) => toSnakeCase(v, options, pathNest, [...path, key]));}).value();}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9oZWxwZXJzL2luZGV4LnRzIl0sIm5hbWVzIjpbImxvZ2dlciIsIkxvZyIsImlzRGF0ZSIsIm9iaiIsIk9iamVjdCIsInByb3RvdHlwZSIsInRvU3RyaW5nIiwiY2FsbCIsInNob3VsZE1vY2siLCJhcGkiLCJNT0NLIiwicHJvY2VzcyIsImVudiIsImluZGV4T2YiLCJnZXRIZWFkZXIiLCJyZXF1ZXN0IiwibmFtZSIsImhlYWRlcnMiLCJ0b1RpdGxlQ2FzZSIsInRvTG93ZXJDYXNlIiwidG9VcHBlckNhc2UiLCJzdHIiLCJzbWFsbFdvcmRzIiwiYWxwaGFudW1lcmljUGF0dGVybiIsIndvcmRTZXBhcmF0b3JzIiwic3BsaXQiLCJtYXAiLCJjdXJyZW50IiwiaW5kZXgiLCJhcnJheSIsInNlYXJjaCIsImxlbmd0aCIsInN1YnN0ciIsInJlcGxhY2UiLCJtIiwibWF0Y2giLCJqb2luIiwid3JhcEFzeW5jIiwiZm4iLCJyZXEiLCJyZXMiLCJuZXh0IiwiY2F0Y2giLCJtZXRob2RUb0FjdGlvbiIsIkRFTEVURSIsIlBBVENIIiwiUE9TVCIsIlBVVCIsIm1ldGhvZCIsInRvU25ha2VDYXNlIiwib3B0aW9ucyIsImlnbm9yZVRyYW5zZm9ybUJ5S2V5IiwiaWdub3JlU25ha2VLZXkiLCJwYXRoTmVzdCIsInBhdGgiLCJoYXNPd25Qcm9wZXJ0eSIsIklEIiwibWFwS2V5cyIsInZhbHVlIiwia2V5Iiwic2hvdWxkSWdub3JlIiwiZmluZEluZGV4IiwiaSIsIm1hcFZhbHVlcyIsInBhcnNlZFBhdGgiLCJwYXRoSGFuZGxlciIsImZpbmQiLCJwIiwiQXJyYXkiLCJpc0FycmF5IiwiZGVmYXVsdFZhbHVlIiwidHJhbnNmb3JtRnVuY3Rpb24iLCJ2IiwiayIsInZhbCIsInN1YlZhbHVlIiwicHJvcCIsImluY2x1ZGVzIl0sIm1hcHBpbmdzIjoiMmVBQUE7QUFDQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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QU92QixXQUFXLENBQUN1QixDQUFELEVBQUl0QixPQUFKLEVBQWFHLFFBQWIsRUFBdUIsQ0FBQyxHQUFHQyxJQUFKLEVBQVVLLEdBQVYsQ0FBdkIsQ0FBM0MsQ0FBUCxDQUNELENBOURJLEVBK0RKRCxLQS9ESSxFQUFQLENBZ0VEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IExvZyBmcm9tICdAL2xvZ2dlcic7XG5pbXBvcnQge2NoYWluLCBpc09iamVjdCwgdHJhbnNmb3JtLCBzbmFrZUNhc2V9IGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge05leHRGdW5jdGlvbiwgUmVxdWVzdCwgUmVzcG9uc2V9IGZyb20gJ2V4cHJlc3MnO1xuaW1wb3J0IHtJU3RhdGVVcGRhdGVQYXRoLCBKU09OQXJyYXksIEpTT05PYmplY3QsIEpTT05QcmltaXRpdmV9IGZyb20gJ0AvdHlwaW5ncyc7XG5pbXBvcnQge0JhZFJlcXVlc3RFcnJvcn0gZnJvbSAnQC9oZWxwZXJzL2Vycm9ycyc7XG5cbmV4cG9ydCBjb25zdCBsb2dnZXIgPSBMb2cubG9nZ2VyO1xuXG5leHBvcnQgY29uc3QgaXNEYXRlID0gKG9iajogb2JqZWN0KSA9PiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwob2JqKSA9PT0gJ1tvYmplY3QgRGF0ZV0nO1xuXG5leHBvcnQgY29uc3Qgc2hvdWxkTW9jayA9IChhcGk6IHN0cmluZykgPT4ge1xuICBjb25zdCBNT0NLID0gcHJvY2Vzcy5lbnYuTU9DSyB8fCAnJztcbiAgcmV0dXJuIE1PQ0suaW5kZXhPZihhcGkpICE9PSAtMSB8fCBNT0NLLmluZGV4T2YoJyonKSAhPT0gLTE7XG59O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0SGVhZGVyKHJlcXVlc3Q6IFJlcXVlc3QsIG5hbWU6IHN0cmluZykge1xuICByZXR1cm4gcmVxdWVzdC5oZWFkZXJzW3RvVGl0bGVDYXNlKG5hbWUpXVxuICAgIHx8IHJlcXVlc3QuaGVhZGVyc1tuYW1lLnRvTG93ZXJDYXNlKCldXG4gICAgfHwgcmVxdWVzdC5oZWFkZXJzW25hbWUudG9VcHBlckNhc2UoKV07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0b1RpdGxlQ2FzZShzdHI6IHN0cmluZykge1xuICBjb25zdCBzbWFsbFdvcmRzID0gL14oYXxhbnxhbmR8YXN8YXR8YnV0fGJ5fGVufGZvcnxpZnxpbnxub3J8b2Z8b258b3J8cGVyfHRoZXx0b3x2Lj98dnMuP3x2aWEpJC9pO1xuICBjb25zdCBhbHBoYW51bWVyaWNQYXR0ZXJuID0gLyhbQS1aYS16MC05XFx1MDBDMC1cXHUwMEZGXSkvO1xuICBjb25zdCB3b3JkU2VwYXJhdG9ycyA9IC8oWyA64oCT4oCULV0pLztcblxuICByZXR1cm4gc3RyLnNwbGl0KHdvcmRTZXBhcmF0b3JzKVxuICAgIC5tYXAoKGN1cnJlbnQ6IHN0cmluZywgaW5kZXg6IG51bWJlciwgYXJyYXk6IHN0cmluZ1tdKSA9PiB7XG4gICAgICBpZiAoXG4gICAgICAgIC8qIENoZWNrIGZvciBzbWFsbCB3b3JkcyAqL1xuICAgICAgICBjdXJyZW50LnNlYXJjaChzbWFsbFdvcmRzKSA+IC0xICYmXG4gICAgICAgIC8qIFNraXAgZmlyc3QgYW5kIGxhc3Qgd29yZCAqL1xuICAgICAgICBpbmRleCAhPT0gMCAmJlxuICAgICAgICBpbmRleCAhPT0gYXJyYXkubGVuZ3RoIC0gMSAmJlxuICAgICAgICAvKiBJZ25vcmUgdGl0bGUgZW5kIGFuZCBzdWJ0aXRsZSBzdGFydCAqL1xuICAgICAgICBhcnJheVtpbmRleCAtIDNdICE9PSAnOicgJiZcbiAgICAgICAgYXJyYXlbaW5kZXggKyAxXSAhPT0gJzonICYmXG4gICAgICAgIC8qIElnbm9yZSBzbWFsbCB3b3JkcyB0aGF0IHN0YXJ0IGEgaHlwaGVuYXRlZCBwaHJhc2UgKi9cbiAgICAgICAgKGFycmF5W2luZGV4ICsgMV0gIT09ICctJyB8fFxuICAgICAgICAgIChhcnJheVtpbmRleCAtIDFdID09PSAnLScgJiYgYXJyYXlbaW5kZXggKyAxXSA9PT0gJy0nKSlcbiAgICAgICkge1xuICAgICAgICByZXR1cm4gY3VycmVudC50b0xvd2VyQ2FzZSgpO1xuICAgICAgfVxuXG4gICAgICAvKiBJZ25vcmUgaW50ZW50aW9uYWwgY2FwaXRhbGl6YXRpb24gKi9cbiAgICAgIGlmIChjdXJyZW50LnN1YnN0cigxKS5zZWFyY2goL1tBLVpdfFxcLi4vKSA+IC0xKSB7XG4gICAgICAgIHJldHVybiBjdXJyZW50O1xuICAgICAgfVxuXG4gICAgICAvKiBJZ25vcmUgVVJMcyAqL1xuICAgICAgaWYgKGFycmF5W2luZGV4ICsgMV0gPT09ICc6JyAmJiBhcnJheVtpbmRleCArIDJdICE9PSAnJykge1xuICAgICAgICByZXR1cm4gY3VycmVudDtcbiAgICAgIH1cblxuICAgICAgLyogQ2FwaXRhbGl6ZSB0aGUgZmlyc3QgbGV0dGVyICovXG4gICAgICByZXR1cm4gY3VycmVudC5yZXBsYWNlKGFscGhhbnVtZXJpY1BhdHRlcm4sIGZ1bmN0aW9uIG0obWF0Y2gpIHtcbiAgICAgICAgcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7XG4gICAgICB9KTtcbiAgICB9KVxuICAgIC5qb2luKCcnKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdyYXBBc3luYyhmbjogKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSwgbmV4dDogTmV4dEZ1bmN0aW9uKSA9PiBQcm9taXNlPHZvaWQ+KSB7XG4gIHJldHVybiAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlLCBuZXh0OiBOZXh0RnVuY3Rpb24pID0+IHtcbiAgICAvLyBNYWtlIHN1cmUgdG8gYC5jYXRjaCgpYCBhbnkgZXJyb3JzIGFuZCBwYXNzIHRoZW0gYWxvbmcgdG8gdGhlIGBuZXh0KClgXG4gICAgLy8gbWlkZGxld2FyZSBpbiB0aGUgY2hhaW4sIGluIHRoaXMgY2FzZSB0aGUgZXJyb3IgaGFuZGxlci5cbiAgICBmbihyZXEsIHJlcywgbmV4dCkuY2F0Y2gobmV4dCk7XG4gIH07XG59XG5cbmV4cG9ydCBjb25zdCBtZXRob2RUb0FjdGlvbiA9IChyZXE6IFJlcXVlc3QpID0+IHtcbiAgY29uc3QgbWFwOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9ID0ge1xuICAgIERFTEVURTogJ2RlbGV0ZScsXG4gICAgUEFUQ0g6ICdwYXRjaCcsXG4gICAgUE9TVDogJ2NyZWF0ZScsXG4gICAgUFVUOiAndXBkYXRlJyxcbiAgfTtcbiAgcmV0dXJuIG1hcFtyZXEubWV0aG9kXTtcbn07XG5cbmV4cG9ydCBmdW5jdGlvbiB0b1NuYWtlQ2FzZShcbiAgb2JqOiBKU09OT2JqZWN0fEpTT05QcmltaXRpdmV8SlNPTkFycmF5LFxuICBvcHRpb25zOiB7aWdub3JlVHJhbnNmb3JtQnlLZXk/OiBzdHJpbmdbXTsgaWdub3JlU25ha2VLZXk/OiBzdHJpbmdbXX0gPSB7XG4gICAgaWdub3JlVHJhbnNmb3JtQnlLZXk6IFtdLFxuICAgIGlnbm9yZVNuYWtlS2V5OiBbXSxcbiAgfSxcbiAgcGF0aE5lc3Q6IEFycmF5PHtba2V5OiBzdHJpbmddOiBKU09OT2JqZWN0fEpTT05QcmltaXRpdmV9PiA9IFtdLFxuICBwYXRoOiBzdHJpbmdbXSA9IFtdLFxuKTogSlNPTk9iamVjdHxKU09OUHJpbWl0aXZlIHtcbiAgaWYgKHR5cGVvZiBvYmogIT09ICdvYmplY3QnKSB7XG4gICAgcmV0dXJuIG9iajtcbiAgfSBlbHNlIGlmIChvYmogPT09IG51bGwpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfSBlbHNlIGlmIChvYmouaGFzT3duUHJvcGVydHkoJ0lEJykpIHtcbiAgICBkZWxldGUgKG9iaiBhcyB7SUQ/OiBzdHJpbmd9KS5JRDtcbiAgfVxuICByZXR1cm4gY2hhaW4ob2JqKVxuICAgIC5tYXBLZXlzKCh2YWx1ZTogSlNPTk9iamVjdHxKU09OUHJpbWl0aXZlfEpTT05BcnJheSwga2V5OiBzdHJpbmcpID0+IHtcbiAgICAgIGNvbnN0IHNob3VsZElnbm9yZSA9IChvcHRpb25zLmlnbm9yZVNuYWtlS2V5IHx8IFtdKS5maW5kSW5kZXgoKGkpID0+IGkgPT09IGtleSkgIT09IC0xO1xuICAgICAgaWYgKHNob3VsZElnbm9yZSkge1xuICAgICAgICByZXR1cm4ga2V5O1xuICAgICAgfVxuICAgICAgcmV0dXJuIHNuYWtlQ2FzZShrZXkpO1xuICAgIH0pXG4gICAgLm1hcFZhbHVlcygodmFsdWU6IEpTT05PYmplY3R8SlNPTlByaW1pdGl2ZXxKU09OQXJyYXksIGtleTogc3RyaW5nKSA9PiB7XG4gICAgICBjb25zdCBwYXJzZWRQYXRoID0gWy4uLnBhdGgsIGtleV0uam9pbignLicpO1xuICAgICAgY29uc3QgcGF0aEhhbmRsZXIgPSBwYXRoTmVzdC5maW5kKChwKSA9PiBwW3BhcnNlZFBhdGhdKTtcbiAgICAgIGlmIChcbiAgICAgICAgdmFsdWUgJiZcbiAgICAgICAgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJlxuICAgICAgICAhQXJyYXkuaXNBcnJheSh2YWx1ZSkgJiZcbiAgICAgICAgKHZhbHVlIGFzIHtJRD86IHN0cmluZ30pLmhhc093blByb3BlcnR5KCdJRCcpXG4gICAgICApIHtcbiAgICAgICAgZGVsZXRlICh2YWx1ZSBhcyB7SUQ/OiBzdHJpbmd9KS5JRDtcbiAgICAgIH1cbiAgICAgIGlmIChwYXRoSGFuZGxlcikge1xuICAgICAgICBjb25zdCBkZWZhdWx0VmFsdWUgPSBwYXRoSGFuZGxlcltwYXJzZWRQYXRoXTtcbiAgICAgICAgaWYgKHZhbHVlID09PSBudWxsKSB7XG4gICAgICAgICAgcmV0dXJuIGRlZmF1bHRWYWx1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJhbnNmb3JtKFxuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnlcbiAgICAgICAgICB2YWx1ZSBhcyBhbnksXG4gICAgICAgICAgZnVuY3Rpb24gdHJhbnNmb3JtRnVuY3Rpb24oY3VycmVudDogSlNPTk9iamVjdCwgdjogSlNPTk9iamVjdHxKU09OUHJpbWl0aXZlfEpTT05BcnJheSwgazogc3RyaW5nKSB7XG4gICAgICAgICAgICBsZXQgdmFsO1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodikgJiYgdi5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgdmFsID0gdlswXTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHZhbCA9IHY7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBbbmFtZSwgLi4uc3ViVmFsdWVdID0gc25ha2VDYXNlKGspLnNwbGl0KCdfJyk7XG4gICAgICAgICAgICBpZiAobmFtZSA9PT0gJ2lkJykge1xuICAgICAgICAgICAgICByZXR1cm4gY3VycmVudDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxldCBwcm9wOiBKU09OT2JqZWN0O1xuICAgICAgICAgICAgaWYgKCFjdXJyZW50Py5oYXNPd25Qcm9wZXJ0eShuYW1lKSkge1xuICAgICAgICAgICAgICBwcm9wID0ge307XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBwcm9wID0gY3VycmVudFtuYW1lXSBhcyBKU09OT2JqZWN0O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHN1YlZhbHVlLmxlbmd0aCkge1xuICAgICAgICAgICAgICBwcm9wW3N1YlZhbHVlLmpvaW4oJ18nKV0gPSB2YWwgfHwgbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGN1cnJlbnRbbmFtZV0gPSBwcm9wO1xuICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnQ7XG4gICAgICAgICAgfSxcbiAgICAgICAgICB7fSk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgICghaXNPYmplY3QodmFsdWUpICYmICFBcnJheS5pc0FycmF5KHZhbHVlKSlcbiAgICAgICAgfHwgaXNEYXRlKHZhbHVlKVxuICAgICAgICB8fCAob3B0aW9ucy5pZ25vcmVUcmFuc2Zvcm1CeUtleSB8fCBbXSkuaW5jbHVkZXMoa2V5KSkge1xuICAgICAgICByZXR1cm4gdmFsdWU7XG4gICAgICB9XG4gICAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiB0b1NuYWtlQ2FzZSh2YWx1ZSwgb3B0aW9ucywgcGF0aE5lc3QsIFsuLi5wYXRoLCBrZXldKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiAodmFsdWUgYXMgSlNPTkFycmF5KS5tYXAoKHYpID0+IHRvU25ha2VDYXNlKHYsIG9wdGlvbnMsIHBhdGhOZXN0LCBbLi4ucGF0aCwga2V5XSkpO1xuICAgIH0pXG4gICAgLnZhbHVlKCk7XG59XG5cbmV4cG9ydCAqIGZyb20gJy4vYXV0aCc7XG5leHBvcnQgKiBmcm9tICcuL2Vudic7XG5leHBvcnQgKiBmcm9tICcuL2Vycm9ycyc7XG4iXX0=